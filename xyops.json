{
	"type": "xypdf",
	"description": "xyOps Portable Data Object",
	"version": "1.0",
	"items": [
		{
			"type": "plugin",
			"data": {
				"id": "pmkiue8906n0zvg0",
				"title": "PowerShell",
				"enabled": true,
				"type": "event",
				"command": "pwsh",
				"script": "# MARK: Log\nfunction Log {\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)][string]$Text,\n        [Parameter(Mandatory = $false)][ValidateSet('Information', 'Warning', 'Error')][string]$Level = 'Information'\n    )\n    begin {\n        # Nothing to do\n    }\n    process {\n        switch ($Level) {\n            'Information' {\n                $logLevel = 'INFO'\n                break \n            }\n            'Warning' {\n                $logLevel = 'WARN'\n                break\n            }\n            'Error' {\n                $logLevel = 'ERR'\n                break\n            }\n        }\n        if ($Script:enableLogTime -eq $true) {\n            $currentTime = Get-Date\n            Write-Information -MessageData \"[$($currentTime.ToString('yyyy-MM-dd hh:mm:ss:ffff'))][$($logLevel)] $Text\" -InformationAction Continue\n        }\n        else {\n            Write-Information -MessageData \"[$($logLevel)] $Text\" -InformationAction Continue\n        }\n    }\n    end {\n        # Nothing to do\n    }\n}\n\n# MARK: GenerateFilename\nfunction GenerateFilename {\n    param(\n        [Parameter(Mandatory = $true)]$fileType,\n        [Parameter(Mandatory = $false)]$prefix\n    )\n\n    $prefix = $prefix -replace \" \", \"_\"\n    $guid = (New-Guid).Guid\n\n    $outputFile = \"$((![string]::IsNullOrEmpty($prefix)) ? \"$($prefix)_\" : $null)$($guid).$($fileType)\"\n    Log \"Output file: $($outputFile)\"\n    return $outputFile\n}\n\n# MARK: ReportOutput\nfunction ReportOutput {\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)][object]$inputObject\n    )\n\n    # Ensure that a supported type was passed.\n    if ($inputObject.GetType().Name -notin ('PSCustomObject', 'Hashtable')) {\n        Throw \"Unsupported data type.\"\n    }\n\n    Write-Output \"$($inputObject | ConvertTo-Json -Depth 100 -Compress)`n\"\n}\n\n# MARK: ReportProgress\nfunction ReportProgress {\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)][decimal]$percent\n    )\n\t\t\n    ReportOutput ([pscustomobject]@{\n            xy       = 1\n            progress = $percent\n        })\n}\n\n# MARK: ReportFile\nfunction ReportFile {\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)][string]$filename\n    )\n\n    $output = [pscustomobject]@{\n        xy    = 1\n        files = @(\n            @{\n                path   = $filename\n                delete = $false\n            }\n        )\n    }\n\n    ReportOutput $output\n}\n\n# MARK: ReportError\nfunction ReportError {\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true, Position = 0)][string]$jobError,\n        [Parameter(Mandatory = $false, ValueFromPipeline = $true, Position = 1)][int]$errorCode = 999,\n        [Parameter(Mandatory = $false)][switch]$exit\n    )\n\n    # Write out error details\n    Log \"Code: $($errorCode)\" -Level error\n    Log \"Message: $($jobError)\" -Level error\n    if ($jobError.Exception) {\n        Log \"Exception:\" -Level error\n        Log $jobError.Exception -Level error\n    }\n\n    # Report failure\n    ReportOutput ([pscustomobject]@{\n            xy          = 1\n            code        = $errorCode\n            description = \"Job failed!\"\n        })\n\n    if ($exit) {\n        return\n    }\n}\n\n# MARK: Begin\n$xyOps = ConvertFrom-Json -Depth 100 (Read-Host)\n$command = [scriptblock]::create($xyOps.params.command)\n$enableLogTime = $xyOps.params.logtime\n\n# Set current directory to the working directory of the job.\nSet-Location $xyops.cwd\n\n# Write output of the xyOps JSON if enabled.\nif ($xyOps.params.outputxyops) {\n    Write-Information -MessageData \"$(($xyOps | ConvertTo-Json -Depth 100))`n\" -InformationAction Continue\n}\n\nLog 'Job Started'\n\n# Import any .psm1 module files provided from a bucket fetch action.\nif ($xyOps.params.processmodules) {\n    foreach ($moduleFile in ($xyops.input.files.Where({ $_.filename -like \"*.psm1\" }))) {\n        try {\n            Log \"Loading module file: $($moduleFile.filename)\" -Level Information\n            Import-Module \"./$($moduleFile.filename)\"\n        }\n        catch {\n            ReportError $_ -exit\n        }\n    }\n}\n\ntry {\n    # Execute the provided PowerShell script code.\n    & $command\n\n    # Report success\n    ReportOutput ([pscustomobject]@{\n            xy   = 1\n            code = 0\n        })\n}\ncatch {\n    ReportError $_\n}\nfinally {\n    Log 'Job Finished'\t\n}",
				"groups": [],
				"format": "",
				"params": [
					{
						"id": "command",
						"title": "Code Block",
						"type": "code",
						"caption": "A code block that contains the PowerShell script code to be executed.",
						"locked": false,
						"value": "# PowerShell script code goes here\n",
						"required": true
					},
					{
						"id": "logtime",
						"title": "Enable Time in Output",
						"type": "checkbox",
						"caption": "Enables a timestamp on each output line when using the Log helper function",
						"locked": false,
						"value": true
					},
					{
						"id": "outputxyops",
						"title": "Output xyOps JSON Data",
						"type": "checkbox",
						"caption": "Wwrite the job data in JSON format in the job output at the beginning of the job",
						"locked": true,
						"value": false
					},
					{
						"id": "processmodules",
						"title": "Process Module Files",
						"type": "checkbox",
						"caption": "Import all .psm1 files attached to the job input. These files can be manually uploaded each time or added to a bucket to be referenced by a 'Fetch Bucket' action.",
						"locked": false,
						"value": true
					}
				],
				"kill": "parent",
				"runner": false,
				"notes": "",
				"icon": "powershell",
				"uid": "",
				"gid": ""
			}
		}
	]
}