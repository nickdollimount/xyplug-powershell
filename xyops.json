{
	"id": "pmkiue8906n0zvg0",
	"title": "PowerShell",
	"enabled": true,
	"type": "event",
	"command": "pwsh",
	"script": "<#\n.SYNOPSIS\n    xyOps PowerShell event plugin - Executes PowerShell commands within the xyOps environment.\n\n.DESCRIPTION\n    This script is an xyOps event plugin that executes PowerShell code blocks and reports progress,\n    output, and file changes back to the xyOps system. It provides structured logging with\n    optional timestamps and handles job execution with comprehensive error handling.\n    \n    The script reads job parameters from JSON input, executes the provided PowerShell command,\n    and reports results in a standardized format that xyOps can process.\n\n.PARAMETER None\n    This script reads parameters from JSON input via Read-Host.\n\n.NOTES\n    Version:        1.1.0\n    Author:         Nick Dollimount\n    Contributor:    Tim Alderweireldt\n    Copyright:      2026\n    Purpose:        xyOps PowerShell event plugin\n    Features:       - PowerShell 5 and Core support\n                    - Cross-platform compatibility\n                    - Comprehensive helper functions for xyOps integration\n\n#>\n\n[CmdletBinding()]\nparam()\n\nSet-StrictMode -Version Latest\n\n# Initialize script-level variables\n$script:enableLogTime = $false\n$script:xyOps = $null\n\n# ============================================================================\n# Logging Functions\n# ============================================================================\n\nfunction Write-xyOpsJobOutput {\n    <#\n    .SYNOPSIS\n        Writes messages to the xyOps job output stream with optional timestamps.\n    \n    .DESCRIPTION\n        Logs messages to the xyOps job output with configurable timestamp prefixes.\n        Uses the PowerShell Information stream for output.\n    \n    .PARAMETER Message\n        The message to log.\n    \n    .PARAMETER Level\n        The log level (info, warning, error). Default is 'info'.\n    \n    .EXAMPLE\n        Write-xyOpsJobOutput \"Job started successfully\"\n    \n    .EXAMPLE\n        Write-xyOpsJobOutput \"An error occurred\" -Level error\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true, Position = 0, ValueFromPipeline = $true)]\n        [string]$Message,\n\n        [Parameter(Mandatory = $false)]\n        [ValidateSet('info', 'warning', 'error')]\n        [string]$Level = 'info'\n    )\n\n    $timestamp = if ($script:enableLogTime -eq $true) {\n        Get-Date -Format \"yyyy-MM-dd HH:mm:ss\"\n    } else {\n        $null\n    }\n\n    $logMessage = if ($timestamp) {\n        \"[$timestamp] [$Level] $Message\"\n    } else {\n        \"[$Level] $Message\"\n    }\n\n    Write-Information -MessageData $logMessage -InformationAction Continue\n}\n\n# ============================================================================\n# Core Output Functions\n# ============================================================================\n\nfunction Send-xyOpsOutput {\n    <#\n    .SYNOPSIS\n        Sends structured JSON output back to the xyOps system. This is low-level output to xyOps.\n    \n    .DESCRIPTION\n        Converts PowerShell objects to JSON format and writes them to the output stream\n        for consumption by the xyOps system. Supports hashtables, PSCustomObjects, arrays,\n        and primitive types. Automatically flushes output to prevent buffering.\n    \n    .PARAMETER InputObject\n        The object to send to xyOps. Can be a hashtable, PSCustomObject, array, or primitive type.\n    \n    .EXAMPLE\n        Send-xyOpsOutput @{ xy = 1; code = 0 }\n    \n    .EXAMPLE\n        Send-xyOpsOutput ([pscustomobject]@{ xy = 1; progress = 50 })\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)]\n        [object]$InputObject\n    )\n\n    if ($null -eq $InputObject) {\n        Write-Output \"`n\"\n        [Console]::Out.Flush()\n        return\n    }\n\n    if ($InputObject -is [hashtable] -or \n        $InputObject -is [System.Management.Automation.PSCustomObject] -or \n        $InputObject -is [array]) {\n        Write-Output \"$($InputObject | ConvertTo-Json -Depth 100 -Compress)`n\"\n    } elseif ($InputObject -is [string] -or \n            $InputObject -is [int] -or \n            $InputObject -is [bool] -or \n            $InputObject -is [decimal]) {\n        Write-Output \"$InputObject`n\"\n    } else {\n        Throw \"Unsupported data type.\"\n    }\n    \n    # Flush output immediately to prevent buffering issues\n    [Console]::Out.Flush()\n}\n\nfunction Send-xyOpsProgress {\n    <#\n    .SYNOPSIS\n        Reports job progress percentage to xyOps.\n    \n    .DESCRIPTION\n        Sends a progress update to the xyOps system with a percentage value between 0 and 100.\n    \n    .PARAMETER Percent\n        The progress percentage (0-100).\n    \n    .EXAMPLE\n        Send-xyOpsProgress 25\n    \n    .EXAMPLE\n        Send-xyOpsProgress 75.5\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)]\n        [decimal]$Percent\n    )\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy       = 1\n        progress = $Percent / 100\n    })\n}\n\n# ============================================================================\n# File and Data Management Functions\n# ============================================================================\n\nfunction Send-xyOpsFile {\n    <#\n    .SYNOPSIS\n        Reports file changes to the xyOps system so that xyOps can upload the file and use it.\n    \n    .DESCRIPTION\n        Notifies xyOps about files that have been created, modified, or should be tracked\n        during job execution.\n    \n    .PARAMETER Filename\n        The path to the file to report.\n    \n    .EXAMPLE\n        Send-xyOpsFile \"/path/to/output.txt\"\n    \n    .EXAMPLE\n        Send-xyOpsFile \"C:\\temp\\report.log\"\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)]\n        [string]$Filename\n    )\n\n    $output = [pscustomobject]@{\n        xy    = 1\n        files = @(\n            @{\n                path   = $Filename\n                delete = $false\n            }\n        )\n    }\n\n    Send-xyOpsOutput $output\n}\n\nfunction Send-xyOpsPerf {\n    <#\n    .SYNOPSIS\n        Reports performance metrics to xyOps.\n    \n    .DESCRIPTION\n        Sends performance timing data to xyOps for display as a pie chart on the Job Details page.\n        Metrics represent time spent in different categories.\n    \n    .PARAMETER Metrics\n        Hashtable of performance metrics where keys are category names and values are time in seconds.\n    \n    .PARAMETER Scale\n        Optional scale factor if metrics are not in seconds (e.g., 1000 for milliseconds).\n    \n    .EXAMPLE\n        Send-xyOpsPerf @{ db = 18.51; http = 3.22; gzip = 0.84 }\n    \n    .EXAMPLE\n        Send-xyOpsPerf @{ db = 1851; http = 3220; gzip = 840 } -Scale 1000\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true)]\n        [hashtable]$Metrics,\n        \n        [Parameter(Mandatory = $false)]\n        [int]$Scale\n    )\n\n    $output = [pscustomobject]@{\n        xy   = 1\n        perf = $Metrics\n    }\n    \n    if ($Scale) {\n        $output.perf['scale'] = $Scale\n    }\n\n    Send-xyOpsOutput $output\n}\n\nfunction Send-xyOpsLabel {\n    <#\n    .SYNOPSIS\n        Sets a custom label for the job.\n    \n    .DESCRIPTION\n        Adds a custom label to the job which will be displayed alongside the Job ID\n        in the xyOps UI. Useful for differentiating jobs with different parameters.\n    \n    .PARAMETER Label\n        The label text to display.\n    \n    .EXAMPLE\n        Send-xyOpsLabel \"Reindex Database\"\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true, ValueFromPipeline = $true)]\n        [string]$Label\n    )\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy    = 1\n        label = $Label\n    })\n}\n\nfunction Send-xyOpsData {\n    <#\n    .SYNOPSIS\n        Sends arbitrary output data to be passed to the next job.\n    \n    .DESCRIPTION\n        Outputs data that will be automatically passed to the next job in a workflow\n        or via a run event action. Data can be any PowerShell object.\n    \n    .PARAMETER Data\n        The data object to pass to the next job.\n    \n    .EXAMPLE\n        Send-xyOpsData @{ hostname = \"server01\"; status = \"ok\" }\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true)]\n        [object]$Data\n    )\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy   = 1\n        data = $Data\n    })\n}\n\n# ============================================================================\n# UI Display Functions\n# ============================================================================\n\nfunction Send-xyOpsTable {\n    <#\n    .SYNOPSIS\n        Sends tabular data for display in the xyOps UI.\n    \n    .DESCRIPTION\n        Renders a data table on the Job Details page in xyOps.\n    \n    .PARAMETER Rows\n        Array of rows, where each row is an array of column values.\n    \n    .PARAMETER Title\n        Optional title displayed above the table.\n    \n    .PARAMETER Header\n        Optional array of header column names.\n    \n    .PARAMETER Caption\n        Optional caption displayed under the table.\n    \n    .EXAMPLE\n        Send-xyOpsTable -Rows @(@(\"192.168.1.1\", \"Server1\", 100), @(\"192.168.1.2\", \"Server2\", 200)) -Header @(\"IP\", \"Name\", \"Count\")\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true)]\n        [array]$Rows,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Title,\n        \n        [Parameter(Mandatory = $false)]\n        [array]$Header,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Caption\n    )\n\n    $table = @{\n        rows = $Rows\n    }\n    \n    if ($Title) { $table['title'] = $Title }\n    if ($Header) { $table['header'] = $Header }\n    if ($Caption) { $table['caption'] = $Caption }\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy    = 1\n        table = $table\n    })\n}\n\nfunction Send-xyOpsHtml {\n    <#\n    .SYNOPSIS\n        Sends custom HTML content for display in xyOps.\n    \n    .DESCRIPTION\n        Renders custom HTML on the Job Details page. Only basic HTML elements are allowed.\n    \n    .PARAMETER Content\n        The HTML content to display.\n    \n    .PARAMETER Title\n        Optional title displayed above the content.\n    \n    .PARAMETER Caption\n        Optional caption displayed under the content.\n    \n    .EXAMPLE\n        Send-xyOpsHtml -Content \"<h3>Results</h3><p>Job completed <b>successfully</b></p>\" -Title \"Summary\"\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true)]\n        [string]$Content,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Title,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Caption\n    )\n\n    $html = @{\n        content = $Content\n    }\n    \n    if ($Title) { $html['title'] = $Title }\n    if ($Caption) { $html['caption'] = $Caption }\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy   = 1\n        html = $html\n    })\n}\n\nfunction Send-xyOpsText {\n    <#\n    .SYNOPSIS\n        Sends plain text content to display in xyOps in a separate textbox.\n    \n    .DESCRIPTION\n        Renders plain text on the Job Details page with formatting preserved.\n    \n    .PARAMETER Content\n        The plain text content to display.\n    \n    .PARAMETER Title\n        Optional title displayed above the content.\n    \n    .PARAMETER Caption\n        Optional caption displayed under the content.\n    \n    .EXAMPLE\n        Send-xyOpsText -Content \"Log file contents...\" -Title \"Log Output\"\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true)]\n        [string]$Content,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Title,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Caption\n    )\n\n    $text = @{\n        content = $Content\n    }\n    \n    if ($Title) { $text['title'] = $Title }\n    if ($Caption) { $text['caption'] = $Caption }\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy   = 1\n        text = $text\n    })\n}\n\nfunction Send-xyOpsMarkdown {\n    <#\n    .SYNOPSIS\n        Sends Markdown content for display in xyOps.\n    \n    .DESCRIPTION\n        Renders Markdown on the Job Details page (converted to HTML).\n    \n    .PARAMETER Content\n        The Markdown content to display.\n    \n    .PARAMETER Title\n        Optional title displayed above the content.\n    \n    .PARAMETER Caption\n        Optional caption displayed under the content.\n    \n    .EXAMPLE\n        Send-xyOpsMarkdown -Content \"## Results`n- Item 1`n- Item 2\" -Title \"Summary\"\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $true)]\n        [string]$Content,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Title,\n        \n        [Parameter(Mandatory = $false)]\n        [string]$Caption\n    )\n\n    $markdown = @{\n        content = $Content\n    }\n    \n    if ($Title) { $markdown['title'] = $Title }\n    if ($Caption) { $markdown['caption'] = $Caption }\n\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy       = 1\n        markdown = $markdown\n    })\n}\n\n# ============================================================================\n# Input and Parameter Functions\n# ============================================================================\n\nfunction Get-xyOpsInputFiles {\n    <#\n    .SYNOPSIS\n        Gets the list of input files passed to the job.\n    \n    .DESCRIPTION\n        Returns an array of input file metadata objects from the xyOps job input.\n        Files are already downloaded to the current working directory.\n    \n    .EXAMPLE\n        $files = Get-xyOpsInputFiles\n        foreach ($file in $files) {\n            Write-Host \"Processing: $($file.filename)\"\n        }\n    #>\n    [CmdletBinding()]\n    param()\n\n    if ($script:xyOps.input.files) {\n        return $script:xyOps.input.files\n    }\n    return @()\n}\n\nfunction Get-xyOpsParam {\n    <#\n    .SYNOPSIS\n        Gets a parameter value from xyOps or environment variable.\n    \n    .DESCRIPTION\n        Retrieves a parameter value, checking both the params object and environment variables.\n        Environment variables are checked first as xyOps passes params as env vars.\n        When called without a Name parameter, displays all available parameters in a formatted table.\n    \n    .PARAMETER Name\n        The parameter name to retrieve. If omitted, displays all available parameters.\n    \n    .PARAMETER Default\n        Optional default value if parameter is not found.\n    \n    .EXAMPLE\n        $timeout = Get-xyOpsParam -Name \"timeout\" -Default 30\n    \n    .EXAMPLE\n        Get-xyOpsParam\n        # Displays all available parameters from environment and xyOps\n    #>\n    [CmdletBinding()]\n    param(\n        [Parameter(Mandatory = $false)]\n        [string]$Name,\n        \n        [Parameter(Mandatory = $false)]\n        [object]$Default = $null\n    )\n\n    # If no name specified, display all parameters\n    if ([string]::IsNullOrEmpty($Name)) {\n        $paramList = [System.Collections.ArrayList]@()\n        \n        # Collect environment variables\n        $envVars = [Environment]::GetEnvironmentVariables()\n        foreach ($key in $envVars.Keys) {\n            [void]$paramList.Add([PSCustomObject]@{\n                Source = \"Environment\"\n                Name   = $key\n                Value  = $envVars[$key]\n            })\n        }\n        \n        # Collect xyOps params\n        if ($script:xyOps.params) {\n            $script:xyOps.params.PSObject.Properties | ForEach-Object {\n                [void]$paramList.Add([PSCustomObject]@{\n                    Source = \"xyOps\"\n                    Name   = $_.Name\n                    Value  = $_.Value\n                })\n            }\n        }\n        \n        # Display as formatted table\n        return $paramList | Format-Table -Property Source, Name, Value -AutoSize\n    }\n\n    # Check environment variable first (xyOps passes params as env vars)\n    $envValue = [Environment]::GetEnvironmentVariable($Name)\n    if ($null -ne $envValue) {\n        return $envValue\n    }\n    \n    # Check params object\n    if ($script:xyOps.params.$Name) {\n        return $script:xyOps.params.$Name\n    }\n    \n    return $Default\n}\n\n# ============================================================================\n# Main Execution\n# ============================================================================\n\ntry {\n    # Read job parameters from JSON input\n    $script:xyOps = ConvertFrom-Json -Depth 100 (Read-Host)\n    $command = [scriptblock]::create($script:xyOps.params.command)\n    $script:enableLogTime = $script:xyOps.params.logtime\n\n    # Set current directory to the working directory of the job\n    Set-Location $script:xyOps.cwd\n\n    # Output xyOps configuration if requested\n    if ($script:xyOps.params.outputxyops) {\n        $formattedJson = $script:xyOps | ConvertTo-Json -Depth 100\n        $codeBlockStart = '```json'\n        $codeBlockEnd = '```'\n        $markdownContent = \"$codeBlockStart`n$formattedJson`n$codeBlockEnd\"\n        Send-xyOpsMarkdown -Content $markdownContent -Title \"xyOps Job Configuration\"\n    }\n\n    # Determine PowerShell version to use\n    $usePowerShell5 = $script:xyOps.params.UsePowershell5 -eq $true\n    \n    if ($usePowerShell5) {\n        # Validate Windows platform (PowerShell 5 is Windows-only)\n        $runningOnWindows = if ($null -ne $IsWindows) { \n            $IsWindows \n        } else { \n            ($PSVersionTable.PSVersion.Major -le 5) -or ($env:OS -eq \"Windows_NT\") \n        }\n        \n        if (-not $runningOnWindows) {\n            Write-xyOpsJobOutput \"PowerShell 5 is only available on Windows. Current platform: $($PSVersionTable.Platform)\" -Level error\n            Send-xyOpsOutput ([pscustomobject]@{\n                xy          = 1\n                code        = 998\n                description = \"PowerShell 5 is not available on this platform (non-Windows)\"\n            })\n            return\n        }\n        \n        # Check if PowerShell 5 is available\n        $powershellPath = \"$env:SystemRoot\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\"\n        if (-not (Test-Path $powershellPath)) {\n            Write-xyOpsJobOutput \"PowerShell 5 executable not found at: $powershellPath\" -Level error\n            Send-xyOpsOutput ([pscustomobject]@{\n                xy          = 1\n                code        = 998\n                description = \"PowerShell 5 executable not found on this system\"\n            })\n            return\n        }\n        \n        Write-xyOpsJobOutput \"PowerShell Version: 5.x (Windows PowerShell)\"\n    } else {\n        Write-xyOpsJobOutput \"PowerShell Version: $($PSVersionTable.PSVersion) (PowerShell Core)\"\n    }\n\n    Write-xyOpsJobOutput 'Job Started'\n\n    # ========================================================================\n    # Execute User Command\n    # ========================================================================\n    \n    if ($usePowerShell5) {\n        # PowerShell 5 execution: Create wrapper script with xyOps functions\n        $commandString = $script:xyOps.params.command\n        \n        # Extract all xyOps helper functions from the current script\n        $scriptContent = Get-Content $PSCommandPath -Raw\n        \n        # Extract function definitions (from script initialization to main execution)\n        $functionStart = $scriptContent.IndexOf('# Initialize script-level variables')\n        $functionEnd = $scriptContent.IndexOf('# Main Execution')\n        $functionsCode = $scriptContent.Substring($functionStart, $functionEnd - $functionStart)\n        \n        # Create wrapper script with functions and user command\n        $wrapperScript = @\"\n# xyOps Helper Functions for PowerShell 5\n$functionsCode\n\n# User Command\n$commandString\n\"@\n        \n        # Save wrapper script to temporary file\n        $wrapperScriptPath = Join-Path $script:xyOps.cwd \"ps5_wrapper_$PID.ps1\"\n        $wrapperScript | Out-File -FilePath $wrapperScriptPath -Encoding UTF8 -Force\n        \n        try {\n            # Execute PowerShell 5 with the wrapper script using direct invocation\n            Push-Location $script:xyOps.cwd\n            \n            $powershellExe = \"$env:SystemRoot\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\"\n            $stdoutPath = \"$($script:xyOps.cwd)\\ps5_stdout.tmp\"\n            $stderrPath = \"$($script:xyOps.cwd)\\ps5_stderr.tmp\"\n            \n            # Use call operator with properly quoted arguments\n            & $powershellExe -NoProfile -NonInteractive -ExecutionPolicy Bypass -File $wrapperScriptPath *> $stdoutPath 2> $stderrPath\n            $exitCode = $LASTEXITCODE\n            \n            Pop-Location\n            \n            # Read and output the results\n            if (Test-Path $stdoutPath) {\n                $stdout = Get-Content $stdoutPath -Raw\n                if ($stdout) {\n                    Write-Information -MessageData $stdout -InformationAction Continue\n                }\n                Remove-Item $stdoutPath -Force -ErrorAction SilentlyContinue\n            }\n            \n            if (Test-Path $stderrPath) {\n                $stderr = Get-Content $stderrPath -Raw\n                if ($stderr) {\n                    Write-xyOpsJobOutput $stderr -Level error\n                }\n                Remove-Item $stderrPath -Force -ErrorAction SilentlyContinue\n            }\n            \n            # Check exit code\n            if ($exitCode -ne 0) {\n                throw \"PowerShell 5 execution failed with exit code: $exitCode\"\n            }\n        } finally {\n            # Clean up wrapper script\n            if (Test-Path $wrapperScriptPath) {\n                Remove-Item $wrapperScriptPath -Force -ErrorAction SilentlyContinue\n            }\n        }\n    } else {\n        # Execute normally in PowerShell Core\n        & $command\n    }\n\n    # Report success\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy   = 1\n        code = 0\n    })\n}\ncatch {\n    # Write out error details\n    Write-xyOpsJobOutput \"Error:\" -Level error\n    Write-xyOpsJobOutput $_ -Level error\n    Write-xyOpsJobOutput \"Exception:\" -Level error\n    Write-xyOpsJobOutput $_.Exception -Level error\n\n    # Report failure\n    Send-xyOpsOutput ([pscustomobject]@{\n        xy          = 1\n        code        = 999\n        description = \"Job failed!\"\n    })\n}\nfinally {\n    Write-xyOpsJobOutput 'Job Finished'\n}",
	"groups": [],
	"format": "",
	"params": [
		{
			"id": "command",
			"title": "Code Block",
			"type": "code",
			"caption": "",
			"locked": false,
			"value": "# PowerShell script code goes here\n",
			"required": true
		},
		{
			"id": "UsePowershell5",
			"title": "Run with Powershell",
			"type": "checkbox",
			"caption": "Run this script with Powershell instead of PWSH (Powershell core)",
			"locked": false,
			"value": false
		},
		{
			"id": "logtime",
			"title": "Enable Time in Output",
			"type": "checkbox",
			"caption": "",
			"locked": false,
			"value": true
		},
		{
			"id": "outputxyops",
			"title": "Output xyOps JSON Data",
			"type": "checkbox",
			"caption": "",
			"locked": true,
			"value": false
		}
	],
	"kill": "parent",
	"runner": false,
	"notes": "",
	"icon": "powershell",
	"uid": "",
	"gid": "",
	"marketplace": {
		"id": "nickdollimount/xyplug-powershell",
		"version": "v1.0.3"
	}
}